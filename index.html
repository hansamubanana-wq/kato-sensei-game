<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ è—¤å…ˆç”Ÿã®æ—¥å¸¸</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'DotGothic16', sans-serif; background-color: #ffe0b2; text-align: center; user-select: none; color: #4e342e; touch-action: manipulation; }
        
        /* è§¦ã£ãŸæ™‚ã®ãƒ–ãƒ«ãƒ–ãƒ« */
        @keyframes jiggle {
            0% { transform: scale(1); }
            25% { transform: scale(1.1) rotate(-5deg); }
            50% { transform: scale(1.1) rotate(5deg); }
            75% { transform: scale(1.1) rotate(-5deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        .jiggle-anim { animation: jiggle 0.4s ease; }
        
        /* æ™®æ®µã®ãµã‚ãµã‚ */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .floating { animation: float 3s ease-in-out infinite; display: inline-block; }

        /* å¯ã¦ã‚‹æ™‚ */
        @keyframes sleep-breath {
            0%, 100% { transform: scale(1); filter: brightness(0.9); }
            50% { transform: scale(1.02); filter: brightness(0.8); }
        }
        .sleeping { animation: sleep-breath 4s infinite !important; }

        .container {
            max-width: 360px; margin: 10px auto; background: #fff8e1;
            border: 4px solid #8d6e63; border-radius: 20px; padding: 15px;
            box-shadow: 0 8px 0 #5d4037;
        }

        .header { display: flex; justify-content: space-between; background: #ffcc80; padding: 5px 10px; border-radius: 10px; font-weight: bold; margin-bottom: 5px; }
        .coin-box { background: #fff; padding: 2px 8px; border-radius: 10px; border: 2px solid #ffa726; color: #ef6c00; }

        .room {
            height: 180px; background: #e0f2f1; margin: 5px 0 15px 0; border-radius: 10px;
            border: 3px solid #80cbc4; position: relative; display: flex; align-items: center; justify-content: center;
            overflow: hidden; transition: background 0.5s;
        }
        .room.night { background: #263238; border-color: #37474f; }
        
        #character { font-size: 80px; cursor: pointer; transition: transform 0.1s; }
        
        .fukidashi {
            position: absolute; top: 10px; right: 10px; background: white;
            padding: 5px 10px; border-radius: 15px; font-size: 12px; border: 2px solid #ccc;
            opacity: 0.9; max-width: 120px; display: none; z-index: 10;
        }

        .param-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 3px; padding: 0 5px; }
        .bar-container { width: 60px; height: 10px; background: #ddd; border-radius: 5px; overflow: hidden; display: inline-block; vertical-align: middle; }
        .bar-fill { height: 100%; transition: width 0.5s; }
        .hp-fill { background: #ef5350; } 
        .food-fill { background: #ffca28; } 
        .exp-fill { background: #42a5f5; }

        .menu-tabs { display: flex; gap: 5px; margin-bottom: 0; }
        .tab-btn { flex: 1; padding: 8px; background: #d7ccc8; border: none; border-radius: 10px 10px 0 0; cursor: pointer; font-family: inherit; font-weight: bold; color: #5d4037; }
        .tab-btn.active { background: #8d6e63; color: white; }

        .action-area { background: #efebe9; padding: 15px; border-radius: 0 0 15px 15px; min-height: 160px; border: 2px solid #8d6e63; border-top: none; }
        .grid-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        button.action-btn {
            background: white; border: 2px solid #a1887f; border-radius: 10px; padding: 10px;
            font-family: inherit; cursor: pointer; display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 4px 0 #d7ccc8; transition: transform 0.1s;
        }
        button.action-btn:active { transform: translateY(3px); box-shadow: none; }
        button.action-btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; transform: none; background: #e0e0e0; }
        
        .btn-icon { font-size: 24px; margin-bottom: 5px; }
        .price { font-size: 10px; color: #ef6c00; font-weight: bold; background: #fff3e0; padding: 2px 5px; border-radius: 4px; }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center;
            z-index: 100; color: white; display: none;
        }
        .modal-content { background: #fff; color: #333; padding: 20px; border-radius: 15px; width: 85%; text-align: center; border: 4px solid #8d6e63; }
        .hidden { display: none !important; }
        .dirt { position: absolute; font-size: 24px; pointer-events: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <span id="rank-display">åµ</span>
        <div class="coin-box">ğŸ’° <span id="money">0</span></div>
    </div>

    <div class="param-row">
        <span>å…ƒæ°— <div class="bar-container"><div id="bar-genki" class="bar-fill hp-fill" style="width:100%"></div></div></span>
        <span>æº€è…¹ <div class="bar-container"><div id="bar-food" class="bar-fill food-fill" style="width:100%"></div></div></span>
        <span>æˆé•· <div class="bar-container"><div id="bar-exp" class="bar-fill exp-fill" style="width:0%"></div></div></span>
    </div>

    <div class="room" id="room" onclick="touchCharacter()">
        <div class="fukidashi" id="speech">...</div>
        <div id="character" class="floating">ğŸ¥š</div>
        <div id="stain-area"></div>
    </div>

    <div class="menu-tabs">
        <button id="btn-care" class="tab-btn active" onclick="switchTab('care')">ãŠä¸–è©±</button>
        <button id="btn-shop" class="tab-btn" onclick="switchTab('shop')">ã‚·ãƒ§ãƒƒãƒ—</button>
        <button id="btn-work" class="tab-btn" onclick="switchTab('work')">ãƒã‚¤ãƒˆ</button>
    </div>

    <div class="action-area">
        <div id="tab-care" class="grid-menu">
            <button class="action-btn" onclick="sleepToggle(); event.stopPropagation();">
                <span class="btn-icon" id="sleep-icon">ğŸ›Œ</span>
                <span id="sleep-text">å¯ã‹ã›ã‚‹</span>
            </button>
            <button class="action-btn" onclick="cleanRoom(); event.stopPropagation();">
                <span class="btn-icon">ğŸ§¹</span>æƒé™¤
            </button>
            <button class="action-btn" onclick="saveAndShare(); event.stopPropagation();">
                <span class="btn-icon">ğŸ’¾</span>ã‚·ã‚§ã‚¢
            </button>
        </div>

        <div id="tab-shop" class="grid-menu hidden">
            <button class="action-btn" onclick="buyFood('rice')"><span class="btn-icon">ğŸ™</span>çµ¦é£Ÿ<div class="price">100P</div></button>
            <button class="action-btn" onclick="buyFood('coffee')"><span class="btn-icon">â˜•</span>ã‚³ãƒ¼ãƒ’ãƒ¼<div class="price">300P</div></button>
            <button class="action-btn" onclick="buyFood('sushi')"><span class="btn-icon">ğŸ£</span>ç‰¹ä¸Šå¯¿å¸<div class="price">1500P</div></button>
            <button class="action-btn" onclick="buyFood('potion')"><span class="btn-icon">ğŸ§ª</span>å…ƒæ°—è–¬<div class="price">500P</div></button>
        </div>

        <div id="tab-work" class="hidden" style="text-align:center;">
            <p style="font-size:12px; margin-bottom:10px;">å…ƒæ°—ã‚’æ¶ˆè²»ã—ã¦ç¨¼ã (æ¶ˆè²»:30)</p>
            <button class="action-btn" style="width:100%; background:#fff9c4;" onclick="startWork()" id="work-btn">
                <span class="btn-icon">ğŸ“</span>æ¡ç‚¹ãƒã‚¤ãƒˆ
            </button>
            <p id="work-msg" style="color:red; font-size:12px; margin-top:5px;"></p>
        </div>
    </div>
</div>

<div id="work-modal" class="modal">
    <div class="modal-content">
        <h3>ğŸ”¥ æ¡ç‚¹ãƒ©ãƒƒã‚·ãƒ¥ ğŸ”¥</h3>
        <p>é€£æ‰“ã—ã¦æ¡ç‚¹ã—ã‚ï¼</p>
        <h1 id="work-score" style="font-size:50px;">0</h1>
        <button onclick="doWorkTap()" style="width:100%; height:80px; font-size:24px; background:#ef5350; color:white; border:none; border-radius:10px;">æ¡ç‚¹ï¼ï¼</button>
    </div>
</div>

<div id="welcome-modal" class="modal">
    <div class="modal-content">
        <h3>ãŠã‹ãˆã‚Šãªã•ã„ï¼</h3>
        <p id="welcome-msg" style="text-align:left; font-size:14px; line-height:1.6;"></p>
        <button onclick="closeWelcome()" style="margin-top:10px; padding:10px 20px;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
    const MAX_VAL = 100;
    const WORK_COST = 30;
    let state = { money: 0, genki: 100, hunger: 100, exp: 0, level: 1, poop: 0, isSleeping: false, lastLogin: Date.now() };

    // ãƒ­ãƒ¼ãƒ‰
    const saved = localStorage.getItem('kato_idle_save');
    if (saved) state = { ...state, ...JSON.parse(saved) };

    const items = {
        'rice': { price: 100, hunger: 30, exp: 5, msg: "ã¾ã‚ã¾ã‚ã ãª" },
        'coffee': { price: 300, hunger: 10, exp: 15, msg: "ç›®ãŒå†´ãˆãŸï¼" },
        'sushi': { price: 1500, hunger: 80, exp: 100, msg: "æ¿€ã‚¦ãƒï¼ï¼" },
        'potion': { price: 500, hunger: 0, exp: 0, msg: "å…ƒæ°—ãŒã¿ãªãã‚‹ï¼", special: 'genki' }
    };

    function init() {
        const now = Date.now();
        const diffMin = Math.floor((now - state.lastLogin) / 60000);
        let log = "";

        if (diffMin > 0) {
            log += `ğŸ’¤ ${diffMin}åˆ†çµŒéã—ã¾ã—ãŸã€‚<br>`;
            const hungerDrop = Math.floor(diffMin * 0.5);
            state.hunger = Math.max(0, state.hunger - hungerDrop);
            if(hungerDrop > 0) log += `ãƒ»ãŠè…¹ãŒ ${hungerDrop} æ¸›ã‚Šã¾ã—ãŸ<br>`;

            let genkiRec = state.isSleeping ? Math.floor(diffMin * 1) : Math.floor(diffMin * 0.1);
            state.genki = Math.min(MAX_VAL, state.genki + genkiRec);
            if(genkiRec > 0) log += `ãƒ»å…ƒæ°—ãŒ ${genkiRec} å›å¾©ï¼<br>`;

            if (!state.isSleeping && diffMin > 60 && Math.random() < 0.5) state.poop++;

            document.getElementById('welcome-msg').innerHTML = log;
            document.getElementById('welcome-modal').style.display = 'flex';
        }

        if (state.isSleeping) setSleepStyle(true);
        updateUI();
        setInterval(saveData, 5000);
    }

    // --- ä¿®æ­£ç®‡æ‰€ï¼šã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ ---
    function switchTab(name) {
        ['care', 'shop', 'work'].forEach(t => document.getElementById('tab-' + t).classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        document.getElementById('tab-' + name).classList.remove('hidden');
        document.getElementById('btn-' + name).classList.add('active');
    }

    // --- ä¿®æ­£ç®‡æ‰€ï¼šè§¦ã£ãŸæ™‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
    function touchCharacter() {
        if (state.isSleeping) return;
        const char = document.getElementById('character');
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ã‚’ä»˜ã‘å¤–ã—
        char.classList.remove('floating');
        char.classList.add('jiggle-anim');
        setTimeout(() => {
            char.classList.remove('jiggle-anim');
            char.classList.add('floating');
        }, 400);

        msg("ã‚„ã‚ã‚ã‚ˆw");
    }

    function buyFood(id) {
        if (state.isSleeping) { alert("å¯ã¦ã„ã¾ã™"); return; }
        const item = items[id];
        if (state.money < item.price) { alert("ãŠé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“"); return; }
        if (state.hunger >= 100 && id !== 'potion') { msg("æº€è…¹ã§ã™"); return; }

        state.money -= item.price;
        if (id === 'potion') state.genki = Math.min(MAX_VAL, state.genki + 50);
        else {
            state.hunger = Math.min(MAX_VAL, state.hunger + item.hunger);
            state.exp += item.exp;
        }
        msg(item.msg); checkEvolve(); updateUI();
    }

    let workCount = 0;
    function startWork() {
        if (state.isSleeping) { alert("å¯ã¦ã„ã¾ã™"); return; }
        if (state.genki < WORK_COST) { msg("ç–²ã‚Œã¦ã¾ã™..."); return; }
        
        state.genki -= WORK_COST; updateUI();
        document.getElementById('work-modal').style.display = 'flex';
        workCount = 0;
        document.getElementById('work-score').innerText = 0;
        
        setTimeout(() => {
            document.getElementById('work-modal').style.display = 'none';
            const salary = workCount * 10;
            state.money += salary;
            state.hunger = Math.max(0, state.hunger - 5);
            alert(`${salary}å†† ç¨¼ãã¾ã—ãŸï¼`);
            updateUI();
        }, 5000);
    }
    function doWorkTap() { workCount++; document.getElementById('work-score').innerText = workCount; }

    function sleepToggle() {
        state.isSleeping = !state.isSleeping;
        setSleepStyle(state.isSleeping);
        saveData();
    }

    function setSleepStyle(isSleep) {
        const room = document.getElementById('room');
        const char = document.getElementById('character');
        const btnText = document.getElementById('sleep-text');
        
        if (isSleep) {
            room.classList.add('night');
            char.classList.remove('floating');
            char.classList.add('sleeping');
            btnText.innerText = "èµ·ã“ã™";
            msg("ãŠã‚„ã™ã¿...");
        } else {
            room.classList.remove('night');
            char.classList.remove('sleeping');
            char.classList.add('floating');
            btnText.innerText = "å¯ã‹ã›ã‚‹";
            msg("ãŠã¯ã‚ˆã†ï¼");
        }
    }

    function cleanRoom() {
        if (state.poop > 0) { state.poop = 0; state.exp += 2; msg("ã‚¹ãƒƒã‚­ãƒªï¼"); updateUI(); }
        else msg("ãã‚Œã„ã ã‚ˆ");
    }

    function checkEvolve() {
        if (state.exp > 100 && state.level === 1) { state.level = 2; alert("é€²åŒ–ï¼(åµå’æ¥­)"); }
        else if (state.exp > 500 && state.level === 2) { state.level = 3; alert("é€²åŒ–ï¼(æ–°ä»»)"); }
        else if (state.exp > 2000 && state.level === 3) { state.level = 4; alert("é€²åŒ–ï¼(ãƒ™ãƒ†ãƒ©ãƒ³)"); }
        else if (state.exp > 5000 && state.level === 4) { state.level = 5; alert("é€²åŒ–ï¼(ä¼èª¬)"); }
    }

    function updateUI() {
        document.getElementById('money').innerText = state.money;
        const chars = ["ğŸ¥š", "ğŸ£", "ğŸ‘¨â€ğŸ«", "ğŸ‘“", "ğŸ§â€â™‚ï¸", "ğŸ‘»"];
        const ranks = ["åµ", "å¹¼å°‘æœŸ", "æ–°ä»»", "ãƒ™ãƒ†ãƒ©ãƒ³", "ä¼èª¬", "éœŠ"];
        document.getElementById('character').innerText = chars[state.level - 1] || "??";
        document.getElementById('rank-display').innerText = ranks[state.level - 1] || "??";

        document.getElementById('bar-genki').style.width = state.genki + "%";
        document.getElementById('bar-food').style.width = state.hunger + "%";
        
        let nextExp = [100, 500, 2000, 5000, 99999][state.level - 1] || 100;
        let expRate = Math.min(100, (state.exp / nextExp) * 100);
        document.getElementById('bar-exp').style.width = expRate + "%";

        const stainArea = document.getElementById('stain-area');
        stainArea.innerHTML = "";
        for(let i=0; i<state.poop; i++){
            let d = document.createElement('div'); d.className = 'dirt'; d.innerText = 'ğŸ’©';
            d.style.top = Math.random()*80 + "%"; d.style.left = Math.random()*80 + "%";
            stainArea.appendChild(d);
        }

        const workBtn = document.getElementById('work-btn');
        const workMsg = document.getElementById('work-msg');
        if (state.genki < WORK_COST) { workBtn.disabled = true; workMsg.innerText = "å…ƒæ°—ä¸è¶³ï¼ˆå¯ã‹ã›ã¦å›å¾©ï¼‰"; }
        else { workBtn.disabled = false; workMsg.innerText = ""; }
    }

    function msg(text) {
        const b = document.getElementById('speech'); b.innerText = text; b.style.display = 'block';
        setTimeout(() => b.style.display = 'none', 3000);
    }
    function saveData() { state.lastLogin = Date.now(); localStorage.setItem('kato_idle_save', JSON.stringify(state)); }
    function closeWelcome() { document.getElementById('welcome-modal').style.display = 'none'; }
    function saveAndShare() { saveData(); navigator.clipboard.writeText(window.location.href).then(() => alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼")); }

    init();
</script>
</body>
</html>