<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ è—¤å…ˆç”Ÿã£ã¡ ãƒ•ãƒ¬ãƒ³ãƒ‰</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'DotGothic16', sans-serif; background-color: #e0f7fa; text-align: center; user-select: none; }
        
        .tamagotchi-shell {
            background: linear-gradient(135deg, #26c6da, #0097a7);
            width: 340px; margin: 10px auto; padding: 30px 20px;
            border-radius: 60% 60% 50% 50%;
            border: 8px solid #006064;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            position: relative;
        }

        .screen {
            background-color: #f1f8e9;
            border: 6px solid #546e7a;
            border-radius: 15px;
            height: 220px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.1);
        }

        /* ãƒ¬ã‚¢åº¦èƒŒæ™¯ */
        .bg-normal { background-color: #f1f8e9; }
        .bg-rare { background-color: #fff9c4; } 
        .bg-legend { background-color: #e1bee7; } 

        .top-bar { display: flex; justify-content: space-between; padding: 5px 10px; font-size: 14px; color: #455a64; font-weight: bold; }
        
        #character-area { height: 120px; display: flex; align-items: center; justify-content: center; font-size: 70px; position: relative; }
        .bounce { animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .poop { position: absolute; font-size: 24px; bottom: 10px; right: 20px; }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 20px; }
        button {
            background: #fff; border: 3px solid #006064; border-radius: 15px; padding: 8px;
            font-family: 'DotGothic16', sans-serif; font-size: 16px; cursor: pointer;
            box-shadow: 0 4px 0 #00838f;
        }
        button:active { transform: translateY(3px); box-shadow: none; }
        
        /* ç‰¹åˆ¥ãªãƒœã‚¿ãƒ³è‰² */
        .gift-btn { grid-column: span 2; background-color: #ff80ab; color: white; border-color: #c51162; }
        
        /* ã‚®ãƒ•ãƒˆå—ä¿¡ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #gift-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); color: white;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100;
        }
        
        #message { height: 20px; color: #d81b60; font-size: 14px; margin-top: 5px; font-weight: bold; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="tamagotchi-shell">
    <div class="screen" id="screen-bg">
        <div class="top-bar">
            <span><span id="generation">1</span>ä»£ç›®</span>
            <span><span id="rarity-star">â˜…</span></span>
            <span><span id="age">0</span>æ‰</span>
        </div>
        <div class="top-bar" style="margin-top:-5px; font-size:12px;">
            <span>æº€è…¹:<span id="hunger">â¤â¤â¤â¤</span></span>
            <span>æ©Ÿå«Œ:<span id="happy">â¤â¤â¤â¤</span></span>
        </div>

        <div id="character-area">
            <div id="character" class="bounce">ğŸ¥š</div>
            <div id="poops"></div>
        </div>
        
        <div id="message"></div>

        <div id="gift-modal" class="hidden">
            <h3 style="margin:0; font-size:40px;">ğŸ</h3>
            <p>å‹é”ã‹ã‚‰<br><span id="gift-name" style="color:yellow; font-weight:bold;">ãƒ¬ã‚¢ãªåµ</span><br>ãŒå±Šãã¾ã—ãŸï¼</p>
            <button onclick="acceptGift()" style="background:#ffeb3b; color:black; width:80%;">è‚²ã¦ã‚‹ï¼</button>
            <button onclick="closeGift()" style="background:#888; color:white; width:80%; margin-top:10px;">å—ã‘å–ã‚‰ãªã„</button>
        </div>
    </div>

    <div class="controls" id="game-buttons">
        <button onclick="feed()">ğŸš ã”ã¯ã‚“</button>
        <button onclick="snack()">ğŸ° ãŠã‚„ã¤</button>
        <button onclick="play()">âš½ ã‚ãã¶</button>
        <button onclick="clean()">ğŸš½ ãƒˆã‚¤ãƒ¬</button>
        <button onclick="createGiftLink()" class="gift-btn">ğŸ åµã‚’å‹é”ã«é€ã‚‹</button>
    </div>

    <div id="reset-area" class="hidden" style="margin-top:20px;">
        <button onclick="resetGame()" style="width:100%; background:#81c784;">ğŸ¥š æ¬¡ã®ä¸–ä»£ã¸</button>
    </div>
</div>

<script>
    // --- ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ---
    let generation = parseInt(localStorage.getItem('kato_gen')) || 1;
    let rarity = localStorage.getItem('kato_rarity') || 'normal'; 
    
    // URLã‹ã‚‰ã‚®ãƒ•ãƒˆãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const urlParams = new URLSearchParams(window.location.search);
    const giftRarity = urlParams.get('gift');

    let hunger = 4, happy = 4, age = 0, poopCount = 0;
    let isAlive = true;
    let character = "ğŸ¥š";

    const rarityConfig = {
        'normal': { star: 'â˜…', bg: 'bg-normal', name: 'æ™®é€šã®åµ' },
        'rare':   { star: 'â˜…â˜…', bg: 'bg-rare', name: 'é‡‘ã®åµ' },
        'legend': { star: 'â˜…â˜…â˜…', bg: 'bg-legend', name: 'ä¼èª¬ã®åµ' }
    };

    // --- åˆæœŸåŒ– ---
    function init() {
        applyRarityStyle();
        evolve();
        updateScreen();

        // ã‚‚ã—ã‚®ãƒ•ãƒˆURLçµŒç”±ãªã‚‰ã€å—ä¿¡ç”»é¢ã‚’è¡¨ç¤º
        if (giftRarity && rarityConfig[giftRarity]) {
            document.getElementById('gift-modal').classList.remove('hidden');
            document.getElementById('gift-name').innerText = rarityConfig[giftRarity].name;
        }
    }

    // --- ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— ---
    setInterval(() => {
        if (!isAlive) return;
        if (Math.random() < 0.2) hunger--;
        if (Math.random() < 0.2) happy--;
        if (Math.random() < 0.15) makePoop();
        if (new Date().getSeconds() % 10 === 0) { age++; evolve(); } // 10ç§’ã§åŠ é½¢
        checkStatus();
        updateScreen();
    }, 1000);

    // --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç³» ---
    function feed() { action(() => { if(hunger<4) { hunger++; msg("ã†ã¾ï¼"); } else msg("æº€è…¹ã "); }); }
    function snack() { action(() => { if(happy<4) { happy++; hunger=Math.max(0,hunger-1); msg("ã‚ã¾ã€œã„"); } }); }
    function play() { action(() => { if(happy<4) { happy++; hunger--; msg("ã‚¦ã‚§ãƒ¼ã‚¤ï¼"); } }); }
    function clean() { action(() => { if(poopCount>0) { poopCount=0; happy++; msg("ã‚¹ãƒƒã‚­ãƒªï¼"); } else msg("ãã‚Œã„ã ã‚ˆ"); }); }
    function makePoop() { if (poopCount < 4) { poopCount++; msg("ãƒ–ãƒªãƒƒ"); } }
    
    function action(func) { if (!isAlive) return; func(); updateScreen(); }

    // --- é€²åŒ–ãƒ»ãƒ¬ã‚¢åº¦ ---
    function evolve() {
        if (age < 5) character = rarity === 'legend' ? "ğŸ‰" : (rarity === 'rare' ? "ğŸ£" : "ğŸ¥š");
        else if (age < 15) character = rarity === 'legend' ? "ğŸ‘½" : (rarity === 'rare' ? "ğŸ˜" : "ğŸ‘¦");
        else {
            if (rarity === 'legend') character = "ğŸ§â€â™‚ï¸"; 
            else if (rarity === 'rare') character = "ğŸ¤´"; 
            else character = "ğŸ‘¨â€ğŸ«"; 
        }
    }

    function checkStatus() {
        hunger = Math.max(0, Math.min(4, hunger));
        happy = Math.max(0, Math.min(4, happy));
        if (hunger === 0 || poopCount >= 4) endGame("å®¶å‡ºã—ã¾ã—ãŸ...", "ğŸƒğŸ’¨");
        else if (age >= 30) endGame("çµå©šã—ã¦å¼•é€€ï¼", "ğŸ’’");
    }

    function endGame(text, icon) {
        isAlive = false; msg(text); character = icon;
        document.getElementById("game-buttons").classList.add("hidden");
        document.getElementById("reset-area").classList.remove("hidden");
    }

    function resetGame() {
        // æ¬¡ã®ä¸–ä»£ã¯ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆé€šå¸¸ãƒ—ãƒ¬ã‚¤æ™‚ï¼‰
        let nextRarity = 'normal';
        if (Math.random() < 0.05) nextRarity = 'legend';
        else if (Math.random() < 0.2) nextRarity = 'rare';

        localStorage.setItem('kato_gen', generation + 1);
        localStorage.setItem('kato_rarity', nextRarity);
        // URLã®ã‚®ãƒ•ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¶ˆã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰
        window.location.href = window.location.pathname;
    }

    // --- â˜…ã“ã“ãŒæ–°æ©Ÿèƒ½ï¼šã‚®ãƒ•ãƒˆã‚·ã‚¹ãƒ†ãƒ  ---

    // 1. å‹é”ã«é€ã‚‹URLã‚’ä½œã‚‹
    function createGiftLink() {
        // ä»Šã®è‡ªåˆ†ã®ãƒ¬ã‚¢åº¦ã‚’URLã«ã™ã‚‹
        const currentUrl = window.location.href.split('?')[0]; // ç¾åœ¨ã®URLï¼ˆ?ä»¥é™ã‚«ãƒƒãƒˆï¼‰
        const giftUrl = `${currentUrl}?gift=${rarity}`;
        
        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        navigator.clipboard.writeText(giftUrl).then(() => {
            alert(`ğŸ åµã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n\n${giftUrl}\n\nLINEã§å‹é”ã«é€ã£ã¦ã‚ã’ã¦ã­ï¼`);
        });
    }

    // 2. ã‚®ãƒ•ãƒˆã‚’å—ã‘å–ã‚‹
    function acceptGift() {
        // ä»Šã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¦ã€ãã®ãƒ¬ã‚¢åº¦ã§ã‚¹ã‚¿ãƒ¼ãƒˆ
        localStorage.setItem('kato_gen', 1); // ã‚‚ã‚‰ã†ã¨1ä»£ç›®ã‹ã‚‰
        localStorage.setItem('kato_rarity', giftRarity);
        
        // URLã® ?gift=... ã‚’æ¶ˆã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆç¶ºéº—ãªURLã«ã™ã‚‹ï¼‰
        window.location.href = window.location.pathname;
    }

    function closeGift() {
        document.getElementById('gift-modal').classList.add('hidden');
    }

    // --- ç”»é¢æ›´æ–° ---
    function applyRarityStyle() {
        const config = rarityConfig[rarity];
        document.getElementById('screen-bg').className = `screen ${config.bg}`;
        document.getElementById('rarity-star').innerText = config.star;
    }

    function updateScreen() {
        document.getElementById("hunger").innerText = "â¤".repeat(hunger) + "â™¡".repeat(4 - hunger);
        document.getElementById("happy").innerText = "â¤".repeat(happy) + "â™¡".repeat(4 - happy);
        document.getElementById("age").innerText = age;
        document.getElementById("character").innerText = character;
        const poopArea = document.getElementById("poops");
        poopArea.innerHTML = "";
        for(let i=0; i<poopCount; i++) {
            let p = document.createElement("div"); p.className = "poop"; p.innerText = "ğŸ’©";
            p.style.right = (i * 25 + 5) + "px"; poopArea.appendChild(p);
        }
    }

    function msg(text) {
        document.getElementById("message").innerText = text;
        setTimeout(() => document.getElementById("message").innerText = "", 2000);
    }

    init();
</script>
</body>
</html>